library(SingleCellExperiment)
library(SC3)
library(scater)
library(reshape2)
args<-commandArgs(T)
data1<-read.table(args[1],sep="\t",header=T,row.names=1)
data1<-t(data1)
set.seed(123)
sce <- SingleCellExperiment( assays = list(counts = as.matrix(data1),logcounts = as.matrix(data1)))
rowData(sce)$feature_symbol <- rownames(sce)
sce <- sc3_prepare(sce,gene_filter = FALSE)
sce <- sc3(sce, ks = 6, biology = TRUE,gene_filter = FALSE,rand_seed=5)
#number<-c(summary(metadata(sce)$sc3$consensus$`3`$silhouette)$avg.width,summary(metadata(sce)$sc3$consensus$`4`$silhouette)$avg.width,summary(metadata(sce)$sc3$consensus$`5`$silhouette)$avg.width,summary(metadata(sce)$sc3$consensus$`6`$silhouette)$avg.width,summary(metadata(sce)$sc3$consensus$`7`$silhouette)$avg.width,summary(metadata(sce)$sc3$consensus$`8`$silhouette)$avg.width,summary(metadata(sce)$sc3$consensus$`9`$silhouette)$avg.width,summary(metadata(sce)$sc3$consensus$`10`$silhouette)$avg.width,summary(metadata(sce)$sc3$consensus$`11`$silhouette)$avg.width,summary(metadata(sce)$sc3$consensus$`12`$silhouette)$avg.width)
#temp<-cbind(seq(3,12),number)
#temp<-as.data.frame(temp)
#value<-temp[order(temp[,2],decreasing = T),][1,1]
output<-metadata(sce)$sc3$consensus$`6`$consensus
row.names(output)<-colnames(data1)
colnames(output)<-colnames(data1)
write.table(output,args[2],row.names=T,col.names=T,sep="\t",quote=F)
library(reshape2)
#library(umap)
library(Rtsne)
#set.seed(123)
#results_umap <- uwot::umap(output,n_sgd_threads=1)
#results_umap <- as.data.frame(results_umap)
set.seed(123)
tsne <- Rtsne(output, dims = 2, perplexity=15, verbose=TRUE, max_iter = 10000, check_duplicates = FALSE)
tSNEdata<-as.data.frame(cbind(tsne$Y))
fit_cluster_hierarchical=hclust(dist(scale(tSNEdata)))
library(NbClust)
nc<-NbClust(tSNEdata,min.nc = 5,max.nc = 15,method = "complete")
knumber<-seq(5,15)[which.max(as.data.frame(nc$All.index)$Silhouette)]
library(scater)
pdf(args[3],height=4,width=6)
ggplot(tSNEdata)+geom_point(aes(x=V1,y=V2,col=factor(cutree(fit_cluster_hierarchical,k=knumber))))+theme_bw()+xlab("tSNE-1")+ylab("tSNE-2")
dev.off()
write.table(as.data.frame(cbind(colnames(data1),tSNEdata,factor(cutree(fit_cluster_hierarchical,k=knumber)))),args[4],row.names=F,col.names=F,sep="\t",quote=F)
